import { FormArray } from "@angular/forms";
import { VALUE_CHANGED_SYNC, PATCH } from "../const/app.const";
import { isMatched, clone } from './entity.service';
import { ObjectMaker } from '../util/object-maker';
const PROP_ARRAY = "propArray";
export class RxFormArray extends FormArray {
    constructor(arrayObject, controls, validatorOrOpts, asyncValidator, arrayConfig) {
        super(controls, validatorOrOpts, asyncValidator);
        this.arrayObject = arrayObject;
        this.arrayConfig = arrayConfig;
        this._isModified = false;
        this._modified = [];
        this.cloneObject(arrayObject);
    }
    get isModified() {
        return this._isModified;
    }
    push(control, options = { isAddedInstance: false }) {
        let formGroup = this.root;
        if (this.arrayObject)
            if (control.modelInstance) {
                if (!options.isAddedInstance)
                    this.arrayObject.push(control.modelInstance);
                else
                    this.arrayObject[this.arrayObject.length] = control.modelInstance;
            }
        super.push(control);
        if (formGroup[VALUE_CHANGED_SYNC])
            formGroup.valueChangedSync();
        this.patch();
        this.checkValidation();
    }
    patch() {
        this.checkModification();
        if (this.parent)
            this.parent[PATCH]();
    }
    resetForm(options) {
        if (options && options.index >= 0 && options.groupOption) {
            this.controls[options.index].resetForm(options.groupOption);
        }
        else {
            for (var i = 0; i < this._baseValue.length; i++) {
                if (this.controls[i] !== undefined)
                    this.controls[i].resetForm({ value: this._baseValue[i] });
                else if (options && options.pushFunction) {
                    let formGroup = options.pushFunction(this._baseValue[i]);
                    this.push(formGroup);
                }
            }
        }
    }
    commit() {
        this._baseValue = [];
        for (let formGroup of this.controls) {
            formGroup.commit();
            this._baseValue.push(clone(formGroup.value));
        }
        this.patch();
    }
    removeAt(index, options = { isRemovedInstance: false }) {
        let formGroup = this.root;
        if (!options.isRemovedInstance)
            this.arrayObject.splice(index, 1);
        else {
            for (var i = index; i < this.arrayObject.length - 1; i++)
                this.arrayObject[i] = this.arrayObject[i + 1];
            this.arrayObject.pop();
        }
        super.removeAt(index, options);
        if (formGroup[VALUE_CHANGED_SYNC])
            formGroup.valueChangedSync();
        this.patch();
        this.checkValidation();
    }
    checkValidation() {
        setTimeout(() => {
            if (this.arrayConfig != undefined && this.arrayConfig.allowMaxIndex && this.length > this.arrayConfig.allowMaxIndex)
                this.setErrors(ObjectMaker.toJson(PROP_ARRAY, this.arrayConfig, [this.length, this.arrayConfig.allowMaxIndex]));
            else if (this.errors && this.errors[PROP_ARRAY])
                delete this.errors[PROP_ARRAY];
        });
    }
    checkModification() {
        this._isModified = !(this._baseValue.length == this.controls.length);
        if (!this._isModified)
            for (var i = 0; i < this.controls.length; i++) {
                this._isModified = isMatched(this._baseValue[i], this.controls[i].value);
                if (this._isModified)
                    break;
            }
    }
    cloneObject(value) {
        this._baseValue = [];
        for (let row of value) {
            this._baseValue.push(clone(row));
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicngtZm9ybS1hcnJheS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL3JlYWN0aXZlLWZvcm0tdmFsaWRhdG9ycy9zZXJ2aWNlcy9yeC1mb3JtLWFycmF5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUVuRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDbEQsTUFBTSxVQUFVLEdBQVcsV0FBVyxDQUFDO0FBQ3ZDLE1BQU0sT0FBTyxXQUFZLFNBQVEsU0FBUztJQUl0QyxZQUFvQixXQUFrQixFQUFFLFFBQVEsRUFBRSxlQUFxQixFQUFFLGNBQW9CLEVBQVUsV0FBNkQ7UUFDaEssS0FBSyxDQUFDLFFBQVEsRUFBRSxlQUFlLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFEakMsZ0JBQVcsR0FBWCxXQUFXLENBQU87UUFBaUUsZ0JBQVcsR0FBWCxXQUFXLENBQWtEO1FBRjVKLGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGNBQVMsR0FBVSxFQUFFLENBQUM7UUFHMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsSUFBSSxVQUFVO1FBQ1YsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLENBQUMsT0FBWSxFQUFFLFVBR2YsRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFDO1FBQ3pCLElBQUksU0FBUyxHQUFRLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDL0IsSUFBSSxJQUFJLENBQUMsV0FBVztZQUNoQixJQUFJLE9BQU8sQ0FBQyxhQUFhLEVB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QUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUE7Z0JBQ3hFLElBQUksSUFBSSxDQUFDLFdBQVc7b0JBQ2hCLE1BQU07YUFDYjtJQUNULENBQUM7SUFFTyxXQUFXLENBQUMsS0FBWTtRQUM1QixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixLQUFLLElBQUksR0FBRyxJQUFJLEtBQUssRUFBRTtZQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUNwQztJQUNMLENBQUM7Q0FHSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZvcm1BcnJheSB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xyXG5pbXBvcnQgeyBWQUxVRV9DSEFOR0VEX1NZTkMsIFBBVENIIH0gZnJvbSBcIi4uL2NvbnN0L2FwcC5jb25zdFwiO1xyXG5pbXBvcnQgeyBpc01hdGNoZWQsIGNsb25lIH0gZnJvbSAnLi9lbnRpdHkuc2VydmljZSdcclxuaW1wb3J0IHsgUmVzZXRGb3JtVHlwZSB9IGZyb20gXCIuLi9lbnVtcy9yZXNldC10eXBlXCI7XHJcbmltcG9ydCB7IE9iamVjdE1ha2VyIH0gZnJvbSAnLi4vdXRpbC9vYmplY3QtbWFrZXInXHJcbmNvbnN0IFBST1BfQVJSQVk6IHN0cmluZyA9IFwicHJvcEFycmF5XCI7XHJcbmV4cG9ydCBjbGFzcyBSeEZvcm1BcnJheSBleHRlbmRzIEZvcm1BcnJheSB7XHJcbiAgICBwcml2YXRlIF9iYXNlVmFsdWU6IGFueVtdO1xyXG4gICAgcHJpdmF0ZSBfaXNNb2RpZmllZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBfbW9kaWZpZWQ6IGFueVtdID0gW107XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFycmF5T2JqZWN0OiBhbnlbXSwgY29udHJvbHMsIHZhbGlkYXRvck9yT3B0cz86IGFueSwgYXN5bmNWYWxpZGF0b3I/OiBhbnksIHByaXZhdGUgYXJyYXlDb25maWc/OiB7IGFsbG93TWF4SW5kZXg/OiBudW1iZXIsIG1lc3NhZ2VLZXk/OiBzdHJpbmcgfSkge1xyXG4gICAgICAgIHN1cGVyKGNvbnRyb2xzLCB2YWxpZGF0b3JPck9wdHMsIGFzeW5jVmFsaWRhdG9yKTtcclxuICAgICAgICB0aGlzLmNsb25lT2JqZWN0KGFycmF5T2JqZWN0KTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgaXNNb2RpZmllZCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faXNNb2RpZmllZDtcclxuICAgIH1cclxuXHJcbiAgICBwdXNoKGNvbnRyb2w6IGFueSwgb3B0aW9uczoge1xyXG4gICAgICAgIGVtaXRFdmVudD86IGJvb2xlYW4sXHJcbiAgICAgICAgaXNBZGRlZEluc3RhbmNlOiBib29sZWFuIFxyXG4gICAgfSA9IHsgaXNBZGRlZEluc3RhbmNlOiBmYWxzZX0pIHtcclxuICAgICAgICBsZXQgZm9ybUdyb3VwOiBhbnkgPSB0aGlzLnJvb3Q7XHJcbiAgICAgICAgaWYgKHRoaXMuYXJyYXlPYmplY3QpXHJcbiAgICAgICAgICAgIGlmIChjb250cm9sLm1vZGVsSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgIGlmICghb3B0aW9ucy5pc0FkZGVkSW5zdGFuY2UpXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcnJheU9iamVjdC5wdXNoKGNvbnRyb2wubW9kZWxJbnN0YW5jZSk7XHJcbiAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcnJheU9iamVjdFt0aGlzLmFycmF5T2JqZWN0Lmxlbmd0aF0gPSBjb250cm9sLm1vZGVsSW5zdGFuY2VcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICBzdXBlci5wdXNoKGNvbnRyb2wpO1xyXG4gICAgICAgIGlmIChmb3JtR3JvdXBbVkFMVUVfQ0hBTkdFRF9TWU5DXSlcclxuICAgICAgICAgICAgZm9ybUdyb3VwLnZhbHVlQ2hhbmdlZFN5bmMoKVxyXG4gICAgICAgIHRoaXMucGF0Y2goKVxyXG4gICAgICAgIHRoaXMuY2hlY2tWYWxpZGF0aW9uKClcclxuICAgIH1cclxuXHJcbiAgICBwYXRjaCgpIHtcclxuICAgICAgICB0aGlzLmNoZWNrTW9kaWZpY2F0aW9uKCk7XHJcbiAgICAgICAgaWYgKHRoaXMucGFyZW50KVxyXG4gICAgICAgICAgICB0aGlzLnBhcmVudFtQQVRDSF0oKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcmVzZXRGb3JtKG9wdGlvbnM/OiB7XHJcbiAgICAgICAgaW5kZXg6IG51bWJlcixcclxuICAgICAgICBncm91cE9wdGlvbjoge1xyXG4gICAgICAgICAgICByZXNldFR5cGU/OiBSZXNldEZvcm1UeXBlLFxyXG4gICAgICAgICAgICB3aXRoPzogc3RyaW5nW10sXHJcbiAgICAgICAgICAgIHZhbHVlPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcHVzaEZ1bmN0aW9uOiAodmFsdWU6IE9iamVjdCkgPT4gYm9vbGVhbjtcclxuICAgIH0pIHtcclxuICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmluZGV4ID49IDAgJiYgb3B0aW9ucy5ncm91cE9wdGlvbikge1xyXG4gICAgICAgICAgICAoPGFueT50aGlzLmNvbnRyb2xzW29wdGlvbnMuaW5kZXhdKS5yZXNldEZvcm0ob3B0aW9ucy5ncm91cE9wdGlvbilcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2Jhc2VWYWx1ZS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY29udHJvbHNbaV0gIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgICAgICAoPGFueT50aGlzLmNvbnRyb2xzW2ldKS5yZXNldEZvcm0oeyB2YWx1ZTogdGhpcy5fYmFzZVZhbHVlW2ldIH0pO1xyXG4gICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucHVzaEZ1bmN0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmb3JtR3JvdXAgPSBvcHRpb25zLnB1c2hGdW5jdGlvbih0aGlzLl9iYXNlVmFsdWVbaV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1c2goZm9ybUdyb3VwKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuXHJcbiAgICBjb21taXQoKSB7XHJcbiAgICAgICAgdGhpcy5fYmFzZVZhbHVlID0gW11cclxuICAgICAgICBmb3IgKGxldCBmb3JtR3JvdXAgb2YgdGhpcy5jb250cm9scykge1xyXG4gICAgICAgICAgICAoPGFueT5mb3JtR3JvdXApLmNvbW1pdCgpO1xyXG4gICAgICAgICAgICB0aGlzLl9iYXNlVmFsdWUucHVzaChjbG9uZShmb3JtR3JvdXAudmFsdWUpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5wYXRjaCgpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICByZW1vdmVBdChpbmRleDogbnVtYmVyLCBvcHRpb25zOiB7IGVtaXRFdmVudD86IGJvb2xlYW4sIGlzUmVtb3ZlZEluc3RhbmNlPzogYm9vbGVhbiB9ID0geyBpc1JlbW92ZWRJbnN0YW5jZTogZmFsc2UgfSkge1xyXG4gICAgICAgIGxldCBmb3JtR3JvdXA6IGFueSA9IHRoaXMucm9vdDtcclxuICAgICAgICBpZiAoIW9wdGlvbnMuaXNSZW1vdmVkSW5zdGFuY2UpXHJcbiAgICAgICAgICAgIHRoaXMuYXJyYXlPYmplY3Quc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IGluZGV4OyBpIDwgdGhpcy5hcnJheU9iamVjdC5sZW5ndGggLSAxOyBpKyspXHJcbiAgICAgICAgICAgICAgICB0aGlzLmFycmF5T2JqZWN0W2ldID0gdGhpcy5hcnJheU9iamVjdFtpICsgMV07XHJcbiAgICAgICAgICAgIHRoaXMuYXJyYXlPYmplY3QucG9wKCk7XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgc3VwZXIucmVtb3ZlQXQoaW5kZXgsb3B0aW9ucyk7XHJcbiAgICAgICAgaWYgKGZvcm1Hcm91cFtWQUxVRV9DSEFOR0VEX1NZTkNdKVxyXG4gICAgICAgICAgICBmb3JtR3JvdXAudmFsdWVDaGFuZ2VkU3luYygpXHJcbiAgICAgICAgdGhpcy5wYXRjaCgpXHJcbiAgICAgICAgdGhpcy5jaGVja1ZhbGlkYXRpb24oKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNoZWNrVmFsaWRhdGlvbigpIHtcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuYXJyYXlDb25maWcgIT0gdW5kZWZpbmVkICYmIHRoaXMuYXJyYXlDb25maWcuYWxsb3dNYXhJbmRleCAmJiB0aGlzLmxlbmd0aCA+IHRoaXMuYXJyYXlDb25maWcuYWxsb3dNYXhJbmRleClcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RXJyb3JzKE9iamVjdE1ha2VyLnRvSnNvbihQUk9QX0FSUkFZLCB0aGlzLmFycmF5Q29uZmlnLCBbdGhpcy5sZW5ndGgsIHRoaXMuYXJyYXlDb25maWcuYWxsb3dNYXhJbmRleF0pKTtcclxuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5lcnJvcnMgJiYgdGhpcy5lcnJvcnNbUFJPUF9BUlJBWV0pXHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5lcnJvcnNbUFJPUF9BUlJBWV07XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNoZWNrTW9kaWZpY2F0aW9uKCkge1xyXG4gICAgICAgIHRoaXMuX2lzTW9kaWZpZWQgPSAhKHRoaXMuX2Jhc2VWYWx1ZS5sZW5ndGggPT0gdGhpcy5jb250cm9scy5sZW5ndGgpO1xyXG4gICAgICAgIGlmICghdGhpcy5faXNNb2RpZmllZClcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNvbnRyb2xzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9pc01vZGlmaWVkID0gaXNNYXRjaGVkKHRoaXMuX2Jhc2VWYWx1ZVtpXSwgdGhpcy5jb250cm9sc1tpXS52YWx1ZSlcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pc01vZGlmaWVkKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjbG9uZU9iamVjdCh2YWx1ZTogYW55W10pIHtcclxuICAgICAgICB0aGlzLl9iYXNlVmFsdWUgPSBbXTtcclxuICAgICAgICBmb3IgKGxldCByb3cgb2YgdmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5fYmFzZVZhbHVlLnB1c2goY2xvbmUocm93KSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbn1cclxuIl19